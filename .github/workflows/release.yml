name: Release

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    steps:
    - name: Checkout ox
      uses: actions/checkout@v4

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      uses: humbletim/setup-vulkan-sdk@v1.2.1
      with:
        vulkan-query-version: latest
        vulkan-components: Vulkan-Headers, Vulkan-Loader
        vulkan-use-cache: true

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libx11-dev libvulkan-dev

    - name: Build ox
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release

    - name: Run runtime tests
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          ./build/bin/tests/runtime/runtime_tests.exe
        else
          ./build/bin/tests/runtime/runtime_tests
        fi

    - name: Download ox-simulator
      shell: bash
      run: |
        PLATFORM="linux-x64"
        if [ "$RUNNER_OS" == "Windows" ]; then
          PLATFORM="win-x64"
        elif [ "$RUNNER_OS" == "macOS" ]; then
          PLATFORM="mac-arm64"
        fi
        RELEASE_URL="https://github.com/ox-runtime/ox-simulator/releases/latest/download"
        curl -L -o ox-simulator.zip "$RELEASE_URL/ox-simulator-driver-only-${PLATFORM}.zip"

    - name: Unzip ox-simulator
      shell: bash
      run: |
        mkdir -p build/bin/drivers
        if [ "$RUNNER_OS" == "Windows" ]; then
          powershell -Command "Expand-Archive -Path ox-simulator.zip -DestinationPath build/bin/drivers/"
        else
          unzip ox-simulator.zip -d build/bin/drivers/
        fi

    - name: Create zip
      shell: bash
      run: |
        cd build
        mv bin ox-runtime
        rm -rf ox-runtime/tests
        if [ "$RUNNER_OS" == "Windows" ]; then
          ZIP_FILE_NAME="ox-runtime-win-x64.zip"
          powershell -Command "Compress-Archive -Path ox-runtime -DestinationPath $ZIP_FILE_NAME"
        elif [ "$RUNNER_OS" == "macOS" ]; then
          ZIP_FILE_NAME="ox-runtime-mac-arm64.zip"
          zip -r $ZIP_FILE_NAME ox-runtime
        else
          ZIP_FILE_NAME="ox-runtime-linux-x64.zip"
          zip -r $ZIP_FILE_NAME ox-runtime
        fi
        echo "ZIP_FILE=$ZIP_FILE_NAME" >> $GITHUB_ENV

    - name: Set ox_driver.h path
      shell: bash
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          echo "HEADER_FILE=include/ox_driver.h" >> $GITHUB_ENV
        else
          echo "HEADER_FILE=" >> $GITHUB_ENV
        fi

    - name: Upload release asset
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/${{ env.ZIP_FILE }}
          ${{ env.HEADER_FILE }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
