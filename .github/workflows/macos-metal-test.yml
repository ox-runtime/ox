name: macOS Metal Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest

    steps:
    - name: Checkout ox
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake

    - name: Build ox
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release

    - name: Run Metal tests
      run: |
        cd build/bin/tests/runtime
        ./runtime_tests

    - name: Download ox-example-driver
      shell: bash
      run: |
        RELEASE_URL="https://github.com/ox-runtime/ox-driver-example/releases/latest/download"
        curl -L -o ox-example-driver.zip "$RELEASE_URL/ox-example-driver-mac-arm64.zip"

    - name: Unzip ox-example-driver
      shell: bash
      run: |
        mkdir -p build/bin/drivers
        unzip ox-example-driver.zip -d build/bin/drivers/

    - name: Start ox-service
      run: |
        ./build/bin/ox-service &
      shell: bash

    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Download and unzip pyopenxr_examples
      run: |
        curl -L -o pyopenxr_examples.zip https://github.com/ox-runtime/pyopenxr_examples/archive/refs/heads/main.zip
        unzip pyopenxr_examples.zip

    - name: Create venv and install pyopenxr
      run: |
        python -m venv venv
        source venv/bin/activate
        pip install pyopenxr

    - name: Run examples
      run: |
        source venv/bin/activate
        export XR_RUNTIME_JSON=./build/bin/ox_openxr.json
        python pyopenxr_examples-main/xr_examples/track_hmd2.py
        python pyopenxr_examples-main/xr_examples/track_controller.py
        python pyopenxr_examples-main/xr_examples/track_buttons.py
